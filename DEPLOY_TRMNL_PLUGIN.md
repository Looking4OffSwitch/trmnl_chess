# Deploying the TRMNL Plugin

## Prerequisites
- TRMNL account and a device assigned to your account.
- TRMNL CLI (`trmnlp`): `gem install trmnl_preview`
- Production backend live (e.g., `https://chess.example.com`).
- TRMNL webhook URL: from TRMNL dashboard → plugin settings → Webhook URL (format `https://usetrmnl.com/api/custom_plugins/{UUID}`).

## 1) Ensure production URLs in plugin config
From repo root:
```bash
./scripts/restore-prod-config.sh           # uses PROD_DOMAIN=chess.example.com by default
# or override
PROD_DOMAIN=your-domain ./scripts/restore-prod-config.sh
```
This rewrites:
- `trmnl_chess/src/settings.yml`
- `trmnl_chess/.trmnlp.yml`

Key fields should read:
```yaml
polling_url: 'https://<your-domain>/api/trmnl-state'
custom_fields:
  - keyname: backend_url
    name: Backend URL
    field_type: url
    required: true
    default: 'https://<your-domain>'
```

## 2) Create the plugin in TRMNL (if first time)
1. Go to https://usetrmnl.com/dashboard → Plugins → “Create Plugin”.
2. Upload a placeholder (you will push from CLI next).
3. Copy the **Webhook URL** (keep for Vercel `TRMNL_WEBHOOK_URL` and local `.env` if testing webhooks).

## 3) Push plugin assets
```bash
cd trmnl_chess
trmnlp login          # once per machine
trmnlp push
```
If you prefer packaging: `make package-plugin` produces `trmnl_chess.tar.gz` for manual upload.

## 4) Configure plugin settings in dashboard
In Plugins → your plugin:
- Polling URL: `https://<your-domain>/api/trmnl-state`
- Webhook URL: `https://usetrmnl.com/api/custom_plugins/{UUID}` (same as backend env)
- Save.

## 5) Assign to a device
Dashboard → Devices → select device → assign your chess plugin.

## 6) Verify end-to-end
1. Wait for device refresh (~15s) or rely on webhook for near-instant.
2. Scan the QR; create a game; make a move.
3. The TRMNL display should show the board and update after actions.

## 7) Troubleshooting / clean slate
- `.trmnlp.yml` and `settings.yml` must point to prod domain; rerun `restore-prod-config.sh` if unsure.
- `custom_fields` must be a YAML array with `keyname`, `field_type`, and `name`; use the `backend_url` entry generated by `restore-prod-config.sh` (maps/objects are rejected by TRMNL).
- Ensure plugin is assigned to the device (easy to miss).
- Test reachability from the device network: `curl https://<your-domain>/api/trmnl-state` should return `{"status":"welcome"}`.
- Use TRMNL “Debug Logs” in plugin settings to see poll/webhook activity.
- Still stuck? Delete the plugin in the dashboard, rerun `restore-prod-config.sh`, `trmnlp login && trmnlp push`, and reassign to device.
